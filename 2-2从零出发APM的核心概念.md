# 2-1 从零出发：APM 的核心概念

- 讲解 APM 的概念和必要性
- 讲解常见 APM 的形态和使用场景
- 了解 APM 的概念和来源
- 了解常见 APM 的形态、适用场景以及本课程的核心

---

## 当某个产品按钮点击无响应，你怎么排查问题

### 一般的排查链路

1. 检查浏览器是否有报错，点击按钮时是否出发了 js 异常
2. 检查接口是否正确返回数据，接口是否响应
3. 接口报错，检查接口内逻辑是否有问题

前端代码 => 接口/服务出口 => 服务本身

---

## 真实的场景，如何定位？

1. 运营商问题，比如用户的运营商劫持了 js，导致前端代码出错
2. CDN 的某个节点缓存出现问题，导致一个老版本的 js 上线了
3. 用户的机器浏览器版本正好有一个 bug，代码触发了这个 bug
4. 服务锁在的某个机房某台机器故障了（着火了），导致服务挂掉了
5. 服务依赖的一个第三方服务（比如支付），欠费了

## APM 的概念

1. 终端用户体验 - 反映用户的*真实*体验
2. 应用架构映射 - 从监控*逆向*分析出真实链路
3. 应用事务分析 - 能从一个*唯一*的线索（用户）找出整条事务或者操作
4. 深度应用诊断 - *精准*定位问题
5. 分析与报告 - 提供实时精准的大数据查询和可视化

> Application Performance Management （简称 APM）是监控服务的一套技术手段，致力于监控并管理程序的性能和可用性

### APM 的组成原理

APM 包括 Agent，Monitor 及 Dashboard/Console
Agent 用于上报数据，Monitor 用于收集数据，Dashboard 用于展示数据

### APM 的形态 - 服务器性能指标监控

- 对服务依赖的硬件性能进行监控，如 CPU 内存、硬盘容量
- 监控服务器性能指标的实时值，用于紧急问题时及时报警
- 监控历史趋势，可以观察每天的访问情况以及对异常点进行分析
- 服务器邢恩能够指标监控是组基本且最重要的 APM，他就像身体的基本指标，一般出现异常都是比较严重的问题

### APM 的形态 - 服务监控

- 对提供的*服务*进行监控
- 检测服务的*情况*，如请求数、响应数、成功率
- 检测服务的*热点*，异常波动
- 检测服务*来源*，调用方分布
- 服务监控是比较大范围的监控，用于获取服务的大致情况，也用于服务提供者根据服务的流量来配置及其，同时可以看到大范围异常的节点

### APM 的形态 - 错误/异常监控

- 对报错或异常进行监控
- 一般需要主动上报
- 需要提供大量上下文信息才有意义，如当时的 URL，错误堆栈，甚至用户信息
- _价值与上报的消息多少成正比，同样成本也是_

### APM 的形态 - 日志收集

- 对服务的所有情况进行记录，日志式*必不可少*的。不管是业务本身，还是访问记录，都需要尽可能记录日志
- 日志的查询分析很困难，所以 APM 一般都有有日志收集和分析的能力 ELK
- 日志会占用大量硬盘空间，所以需要*定期清除*，清除掉就很难查到问题了
- 日志是服务器中最重要的“证据”，打日志就像前端的 “打点”，因此日志一定要记录有价值的信息，如时间，关键指标，traceId

### APM 的形态 - 依赖监控

- 对服务的依赖进行监控，如数据库，缓存，外部服务
- 几乎所有的*响应缓慢*问题均由依赖导致
- 依赖监控是比较大范围的监控，只能发现问题，很难跟服务本身关联起来

### APM 的终极形态 - 分布式事务追踪

- 真实场景，一个服务从发起到完成，要经历很多的节点
- 传统的 APM 工具只能检测一个或多个节点的情况，无法串起来
- 分布式事务追踪可以通过一个 ID 就可以查询到一次请求的*全链路*情况

#### 分布式事务追踪的实现原理简述

- Trace: 一个完整请求链路
- Span:一个调用过程
- SpanContext: Trace 的全局上下文信息，如 traceId

通过 TraceId 可以查询到每个节点的调用情况

### APM 的形态 - 代码级的监控分析（Profiling）

- 一般利用自动化的代码插桩技术，获取 Node.js 进程内方法的调用链路
- 可以查看调用栈上的总执行事件和每个方法占的百分比

## 我们的目标

- 怎么看 => 通过工具发现 Nodejs 应用的问题、异常、日常监控
- 看什么 => 懂得里面指标的含义，并且能通过指标分析出造成问题的原因，并解决掉
- 避免再看到

## 学习思路

1. 学习部署 APM，并通过 APM 解决问题
2. 学习问题背后的缘由，并通过 APM 解决问题 3.学习正确的理论知识和一系列的编码最佳时间，避免出现 APM 监测的问题

## 总结

- APM 是服务监控的技术手段，是任何服务不可或缺的一部分
- APM 存在各种形态和各种应用场景
- 学习使用 APM 是本次 Nodejs 相关课程的基础
