# Nodejs APM 观看指南

## 介绍

- 讲解 Use Method 的概念
- 讲解常见 Node.js APM 系统中性能指标的解读方法

## 目标

- 了解 Use Method 的概念
- 了解在 node.js APM 实施过程中，需要关注的相关指标
- 了解这些指标通过什么方式可以阅读，怎样阅读

## 如何发现一个 node.js 应用的问题

### 道与术：USE Method 与 APM

- APM 是监控服务的一套*技术手段*
- Utilization 利用率 Saturation 饱和度 Errors 误差（简称 USE）方法是一种能分析任何系统性能的*方法论*

### USE Method 的概念

> 资源：应用雨来的硬件资源（CPU，硬盘，内存）
> 利用率： 以资源一个时间段内被使用的百分比来表示，例如：一个 CPU 以 90% 的利用率运行
> 饱和度：某个资源排队的数量，例如，当前有五个用户在等待
> 误差/错误（数）：出现异常的数量，例如：网络接口有 50 次超时

### CPU/内存/吞吐量

### CPU

什么叫计算密集型和 IO 密集型？

- 计算密集型：计算、逻辑判断量非常大而且集中的类型，因为主要占用 CPU 资源所以又叫 CPU 密集型，当计算任务数等于 CPU 核心数的时候，是 CPU 运行效率最高的时候
- IO 密集型：当磁盘的读取数据和输出数据非常大的类型。由于 I/O 操作的运行事件远远大于 CPU、内存运行时间，所以任务的大部分时间都是在等待 IO 操作完成，I/O 的特点是 CPU 消耗小。

CPU 的 U 过大一定是计算密集型导致的吗？

- CPU 的 Utilization：利用率 90% 的表象
  - 实际的 CPU 的利用率，并不是很高
  - CPU 并非 90%的时间都在忙着，很大一部分时间在等待，或者说“停顿（stalled）”了。多数情况下在等待访问内存，其中又以读内存为主。停顿的周期内，不能执行指令，所以应用或代码不会继续运行。由于 CPU 发展比内存快很多，大部分事件，CPU 都没有运行，而是在等待内存的返回。所以 90 % 的 CPU 不一定是因为 CPU 在忙着计算，过多的内存操作同样课鞥呢会导致。

#### 排查计算密集型 CPU 的利器：火焰图

- X 轴表示时间长度，也就是占用的 CPU 的时间
- Y 轴从上到下，越接近底部表示越接近系统的底层，对于 node 来说，上层是 js 代码，下层是 c 代码
- 每一层上，每个条幅越宽，表示它在整个运行周期中，占用的 CPU 越多

##### 实战：使用 0X 火焰图工具查看 CPU 火焰图

- https://gitee.com/node-apm/cpu-frame-graph
